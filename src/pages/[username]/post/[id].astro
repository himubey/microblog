---
import Base from "../../../layouts/Base.astro";
import { getSupabaseServerClient } from "../../../lib/supabase/server";
import IconReply from "virtual:icons/ic/baseline-chat-bubble-outline";
import IconRepost from "virtual:icons/ic/baseline-repeat";
import IconLike from "virtual:icons/ic/baseline-favorite-border";
import IconLikeFilled from "virtual:icons/ic/baseline-favorite";
import IconQuote from "virtual:icons/ic/baseline-format-quote";

const { id, username } = Astro.params;
const supabase = getSupabaseServerClient(Astro);
const {
  data: { user },
} = await supabase.auth.getUser();
const isLoggedIn = Boolean(user);

const formatFullDate = (ts) =>
  new Intl.DateTimeFormat("en-US", {
    year: "numeric",
    month: "short",
    day: "numeric",
    hour: "numeric",
    minute: "2-digit",
  }).format(new Date(ts));

const escapeHtml = (value) =>
  String(value || "")
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;")
    .replace(/"/g, "&quot;")
    .replace(/'/g, "&#39;");

const linkify = (value) => {
  const escaped = escapeHtml(value);
  const withLinks = escaped.replace(/(https?:\/\/[^\s]+)/g, '<a class="text-link" href="$1" target="_blank" rel="noopener noreferrer">$1</a>');
  return withLinks.replace(/(^|\s)#([\w_]+)/g, (_m, lead, tag) => `${lead}<a class="text-link" href="/tag/${tag.toLowerCase()}">#${tag}</a>`);
};

const error = Astro.url.searchParams.get("error");
const errorText =
  error && error !== "empty" && error !== "toolong"
    ? decodeURIComponent(error)
    : null;

let { data: postRow } = await supabase
  .from("posts")
  .select("id, author_id, content, created_at")
  .eq("id", id)
  .maybeSingle();

let quoteRow = null;
if (!postRow) {
  const { data: foundQuote } = await supabase
    .from("reposts")
    .select("id, user_id, post_id, quote_text, created_at")
    .eq("id", id)
    .eq("type", "quote")
    .maybeSingle();
  quoteRow = foundQuote;
}
let quoteRows = [];
if (postRow) {
  const { data: foundQuotes } = await supabase
    .from("reposts")
    .select("id, user_id, post_id, quote_text, created_at, profiles:profiles!reposts_user_id_fkey (id, username, display_name)")
    .eq("post_id", postRow.id)
    .eq("type", "quote")
    .order("created_at", { ascending: false });
  quoteRows = foundQuotes || [];
  quoteRow = quoteRows[0] || null;
}

let myProfile = null;
if (user) {
  const first = await supabase
    .from("profiles")
    .select("id, username, display_name, bio, pinned_post_id")
    .eq("id", user.id)
    .single();
  if (first.error?.message?.includes("pinned_post_id")) {
    const fallback = await supabase
      .from("profiles")
      .select("id, username, display_name, bio")
      .eq("id", user.id)
      .single();
    myProfile = fallback.data;
  } else {
    myProfile = first.data;
  }
}
const myDisplayName = myProfile?.display_name || user?.user_metadata?.name || "User";
const myUsername = myProfile?.username || user?.user_metadata?.username || user?.email?.split("@")[0] || "user";
const pinFeatureEnabled = Boolean(myProfile && "pinned_post_id" in myProfile);

let postAuthor = null;
if (postRow) {
  const first = await supabase
    .from("profiles")
    .select("id, username, display_name, bio, pinned_post_id")
    .eq("id", postRow.author_id)
    .maybeSingle();
  if (first.error?.message?.includes("pinned_post_id")) {
    const fallback = await supabase
      .from("profiles")
      .select("id, username, display_name, bio")
      .eq("id", postRow.author_id)
      .maybeSingle();
    postAuthor = fallback.data;
  } else {
    postAuthor = first.data;
  }
}

let quoteAuthor = null;
let quotedPost = null;
let quotedAuthor = null;
if (quoteRow?.post_id) {
  const { data: quoteAuthorRow } = await supabase
    .from("profiles")
    .select("id, username, display_name")
    .eq("id", quoteRow.user_id)
    .maybeSingle();
  quoteAuthor = quoteAuthorRow;

  const { data: quotedPostRow } = await supabase
    .from("posts")
    .select("id, author_id, content, created_at")
    .eq("id", quoteRow.post_id)
    .maybeSingle();
  quotedPost = quotedPostRow;

  if (quotedPostRow) {
    const { data: quotedAuthorRow } = await supabase
      .from("profiles")
      .select("id, username, display_name")
      .eq("id", quotedPostRow.author_id)
      .maybeSingle();
    quotedAuthor = quotedAuthorRow;
  }
}

const countBy = (rows, key) => {
  const map = new Map();
  (rows || []).forEach((r) => {
    const k = r[key];
    map.set(k, (map.get(k) || 0) + 1);
  });
  return map;
};

const basePostId = postRow?.id || quotedPost?.id || null;

const { data: repliesData } = await supabase
  .from("posts")
  .select("id, author_id, content, created_at, profiles:profiles!posts_author_id_fkey (id, username, display_name)")
  .eq("reply_to_id", basePostId || id)
  .order("created_at", { ascending: true });

const postIds = [basePostId, ...(repliesData || []).map((r) => r.id)].filter(Boolean);

const { data: repliesCountData } = await supabase
  .from("posts")
  .select("id, reply_to_id")
  .in("reply_to_id", postIds.length ? postIds : ["00000000-0000-0000-0000-000000000000"]);

const { data: likesData } = await supabase
  .from("likes")
  .select("post_id, user_id")
  .in("post_id", postIds.length ? postIds : ["00000000-0000-0000-0000-000000000000"]);

const { data: repostsData } = await supabase
  .from("reposts")
  .select("post_id, user_id")
  .in("post_id", postIds.length ? postIds : ["00000000-0000-0000-0000-000000000000"]);

const replyCounts = countBy(repliesCountData, "reply_to_id");
const likeCounts = countBy(likesData, "post_id");
const repostCounts = countBy(repostsData, "post_id");

const likedSet = new Set(
  (likesData || [])
    .filter((r) => r.user_id === user?.id)
    .map((r) => r.post_id)
);
const repostedSet = new Set(
  (repostsData || [])
    .filter((r) => r.user_id === user?.id)
    .map((r) => r.post_id)
);

const post = postRow
  ? {
      type: "post",
      id: postRow.id,
      authorId: postRow.author_id,
      user: postAuthor?.username || myUsername,
      name: postAuthor?.display_name || postAuthor?.username || myDisplayName,
      text: postRow.content,
      time: formatFullDate(postRow.created_at),
      isOwner: user?.id === postRow.author_id,
      isPinned: pinFeatureEnabled && (postAuthor?.pinned_post_id || myProfile?.pinned_post_id) === postRow.id,
      counts: {
        replies: replyCounts.get(postRow.id) || 0,
        reposts: repostCounts.get(postRow.id) || 0,
        likes: likeCounts.get(postRow.id) || 0,
      },
      liked: likedSet.has(postRow.id),
      reposted: repostedSet.has(postRow.id),
      quoted: null,
    }
  : null;

const replies = (repliesData || []).map((r) => {
  const author = r.profiles;
  return {
    id: r.id,
    authorId: r.author_id,
    user: author?.username || "user",
    name: author?.display_name || author?.username || "User",
    text: r.content,
    time: formatFullDate(r.created_at),
    isOwner: user?.id === r.author_id,
    counts: {
      replies: replyCounts.get(r.id) || 0,
      reposts: repostCounts.get(r.id) || 0,
      likes: likeCounts.get(r.id) || 0,
    },
    liked: likedSet.has(r.id),
    reposted: repostedSet.has(r.id),
  };
});
---
<Base title={`Microblog - Post ${id}`}>
  <div class="card p-3 mb-3 conversation-header">
    <a class="text-link" href="/home" aria-label="Back to timeline">←</a>
    <div class="font-bold">Post</div>
  </div>
  <div class="grid gap-4 md:grid-cols-[2fr_1fr]">
    <div>
      {post ? (
        <>
          <section class="card p-4">
            <div class="grid grid-cols-[48px_1fr] gap-3">
              <img src="/assets/default-avatar.webp" alt="" class="h-12 w-12 rounded border border-border object-cover" />
              <div>
                <div class="flex items-start justify-between gap-2">
                  <div>
                    <a href={`/profile/${post.user}`} class="font-bold text-link">{post.name}</a>
                    <span class="text-muted"> @{post.user}</span>
                  </div>
                  <span class="post-menu-wrap">
                    <button class="post-menu-button" type="button">...</button>
                    <span class="post-menu">
                      {post.isOwner ? (
                        <>
                          <form method="post" action="/api/posts/delete">
                            <input type="hidden" name="post_id" value={post.id} />
                            <button class="post-menu-item danger" type="submit">Delete post</button>
                          </form>
                          {pinFeatureEnabled && (
                            <form method="post" action="/api/posts/pin">
                              <input type="hidden" name="post_id" value={post.id} />
                              <button class="post-menu-item" type="submit">{post.isPinned ? "Unpin from profile" : "Pin to your profile"}</button>
                            </form>
                          )}
                        </>
                      ) : (
                        <>
                          <form method="post" action="/api/follows/unfollow">
                            <input type="hidden" name="followee_id" value={post.authorId} />
                            <button class="post-menu-item" type="submit">Unfollow @{post.user}</button>
                          </form>
                          <form method="post" action="/api/mutes/toggle">
                            <input type="hidden" name="muted_id" value={post.authorId} />
                            <button class="post-menu-item" type="submit">Mute @{post.user}</button>
                          </form>
                          <form method="post" action="/api/blocks/toggle">
                            <input type="hidden" name="blocked_id" value={post.authorId} />
                            <button class="post-menu-item" type="submit">Block @{post.user}</button>
                          </form>
                        </>
                      )}
                      <a class="post-menu-item" href={`/${post.user}/post/${post.id}/activity`}>View post activity</a>
                    </span>
                  </span>
                </div>
                <div class="mt-1 conversation-text" set:html={linkify(post.text)}></div>
                {post.quoted && (
                  <div class="quote-card">
                    <div class="quote-header">
                      <img src="/assets/default-avatar.webp" alt="" class="quote-avatar" />
                      <div>
                        <div class="quote-meta">{post.quoted.name} @{post.quoted.user} · {post.quoted.time}</div>
                        <div class="quote-text" set:html={linkify(post.quoted.text)}></div>
                      </div>
                    </div>
                  </div>
                )}
                <div class="conversation-time">{post.time}</div>
                <div class="post-actions conversation-actions">
                  <a class="action-link action-icon" href="#">
                    <IconReply class="action-icon-svg" />
                    {post.counts.replies}
                  </a>
                  <span class="repost-wrap">
                    <form method="post" action="/api/reposts/repost" class="inline">
                      <input type="hidden" name="post_id" value={post.id} />
                      <button class="action-link action-icon" type="submit">
                        <IconRepost class="action-icon-svg" />
                        {post.counts.reposts}
                      </button>
                    </form>
                    <span class="repost-menu">
                      <form method="post" action="/api/reposts/repost">
                        <input type="hidden" name="post_id" value={post.id} />
                        <button class="post-menu-item" type="submit">Repost</button>
                      </form>
                      <button
                        class="post-menu-item js-quote-trigger"
                        type="button"
                        data-post-id={post.id}
                        data-post-text={post.text}
                        data-post-name={post.name}
                        data-post-user={post.user}
                        data-post-time={post.time}
                      >
                        <IconQuote class="action-icon-svg" /> Quote
                      </button>
                    </span>
                  </span>
                  <form method="post" action="/api/likes/toggle" class="inline">
                    <input type="hidden" name="post_id" value={post.id} />
                    <button class={`action-link action-icon ${post.liked ? "is-liked" : ""}`} type="submit">
                      {post.liked ? <IconLikeFilled class="action-icon-svg" /> : <IconLike class="action-icon-svg" />}
                      {post.counts.likes}
                    </button>
                  </form>
                </div>
              </div>
            </div>
          </section>
          {quoteRows.length > 0 && (
            <section class="card mt-3">
              <div class="border-b border-[#edf3f7] px-3 py-2 text-xs text-muted">Quotes</div>
              {quoteRows.map((q) => (
                <div class="post-card">
                  <img src="/assets/default-avatar.webp" alt="" class="post-avatar" />
                  <div class="post-body">
                    <div class="post-header">
                      <div class="post-meta">
                        <a href={`/profile/${q.profiles?.username || "user"}`} class="font-bold text-link">
                          {q.profiles?.display_name || q.profiles?.username || "User"}
                        </a>
                        <span class="post-handle"> @{q.profiles?.username || "user"}</span>
                        <span class="post-time">· {formatFullDate(q.created_at)}</span>
                      </div>
                    </div>
                    <div class="post-content" set:html={linkify(q.quote_text)}></div>
                  </div>
                </div>
              ))}
            </section>
          )}
        </>
      ) : (
        <section class="card p-4 text-sm text-muted">Post not found.</section>
      )}

      <section class="card mt-3 p-4">
        <strong>Post your reply</strong>
        {error === "empty" && <div class="mt-2 text-xs text-red-600">Reply cannot be empty.</div>}
        {error === "toolong" && <div class="mt-2 text-xs text-red-600">Reply must be 140 characters or fewer.</div>}
        {errorText && <div class="mt-2 text-xs text-red-600">{errorText}</div>}
        <form method="post" action="/api/posts/reply" class="mt-2" novalidate>
          <input type="hidden" name="post_id" value={basePostId || id} />
          <textarea class="h-14 w-full resize-none rounded border border-border p-2 text-sm" name="content" placeholder="Write your reply in 140 characters..." disabled={!isLoggedIn}></textarea>
          <div class="mt-2 flex items-center justify-between text-xs text-muted">
            <span>140</span>
            <button class="btn" type="submit" disabled={!isLoggedIn}>Reply</button>
          </div>
          {!isLoggedIn && <div class="mt-2 text-xs text-muted">Sign in to reply.</div>}
        </form>
      </section>

      <section class="card mt-3">
        <div class="border-b border-[#edf3f7] px-3 py-2 text-xs text-muted">Replies</div>
        {replies.length === 0 && (
          <div class="p-4 text-sm text-muted">No replies yet.</div>
        )}
        {replies.map((reply) => (
          <div class="grid grid-cols-[48px_1fr] gap-3 border-b border-[#edf3f7] p-3 last:border-b-0">
            <img src="/assets/default-avatar.webp" alt="" class="h-12 w-12 rounded border border-border object-cover" />
            <div>
              <div class="flex items-start justify-between gap-2">
                <div>
                  <a href={`/profile/${reply.user}`} class="font-bold text-link">{reply.name}</a>
                  <span class="text-muted"> @{reply.user}</span>
                </div>
                <span class="post-menu-wrap">
                  <button class="post-menu-button" type="button">...</button>
                  <span class="post-menu">
                    {reply.isOwner ? (
                      <>
                        <form method="post" action="/api/posts/delete">
                          <input type="hidden" name="post_id" value={reply.id} />
                          <button class="post-menu-item danger" type="submit">Delete post</button>
                        </form>
                      </>
                    ) : (
                      <>
                        <form method="post" action="/api/follows/unfollow">
                          <input type="hidden" name="followee_id" value={reply.authorId} />
                          <button class="post-menu-item" type="submit">Unfollow @{reply.user}</button>
                        </form>
                        <form method="post" action="/api/mutes/toggle">
                          <input type="hidden" name="muted_id" value={reply.authorId} />
                          <button class="post-menu-item" type="submit">Mute @{reply.user}</button>
                        </form>
                        <form method="post" action="/api/blocks/toggle">
                          <input type="hidden" name="blocked_id" value={reply.authorId} />
                          <button class="post-menu-item" type="submit">Block @{reply.user}</button>
                        </form>
                      </>
                    )}
                    <a class="post-menu-item" href={`/${reply.user}/post/${reply.id}/activity`}>View post activity</a>
                  </span>
                </span>
              </div>
              <div class="mt-1" set:html={linkify(reply.text)}></div>
              <div class="mt-1 text-xs text-muted">{reply.time} - via web</div>
              <div class="post-actions">
                <a class="action-link action-icon" href="#">
                  <IconReply class="action-icon-svg" />
                  {reply.counts.replies}
                </a>
                <span class="repost-wrap">
                  <form method="post" action="/api/reposts/repost" class="inline">
                    <input type="hidden" name="post_id" value={reply.id} />
                    <button class="action-link action-icon" type="submit">
                      <IconRepost class="action-icon-svg" />
                      {reply.counts.reposts}
                    </button>
                  </form>
                  <span class="repost-menu">
                    <form method="post" action="/api/reposts/repost">
                      <input type="hidden" name="post_id" value={reply.id} />
                      <button class="post-menu-item" type="submit">Repost</button>
                    </form>
                    <button
                      class="post-menu-item js-quote-trigger"
                      type="button"
                      data-post-id={reply.id}
                      data-post-text={reply.text}
                      data-post-name={reply.name}
                      data-post-user={reply.user}
                      data-post-time={reply.time}
                    >
                      <IconQuote class="action-icon-svg" /> Quote
                    </button>
                  </span>
                </span>
                <form method="post" action="/api/likes/toggle" class="inline">
                  <input type="hidden" name="post_id" value={reply.id} />
                  <button class={`action-link action-icon ${reply.liked ? "is-liked" : ""}`} type="submit">
                    {reply.liked ? <IconLikeFilled class="action-icon-svg" /> : <IconLike class="action-icon-svg" />}
                    {reply.counts.likes}
                  </button>
                </form>
              </div>
            </div>
          </div>
        ))}
      </section>
    </div>

    <aside class="card p-4">
      <h3 class="text-sm font-bold">Conversation</h3>
      <p class="mt-1 text-xs text-muted">You are viewing a single post and its replies.</p>
      <h3 class="mt-3 text-sm font-bold">More</h3>
      <p class="mt-1 text-xs text-muted">See <a class="text-link" href="/home">Home</a> for the full timeline.</p>
    </aside>
  </div>

  <dialog class="quote-dialog" id="quote-dialog">
    <div class="dialog-header">
      <div class="dialog-title">Quote post</div>
      <button class="post-menu-button" type="button" data-quote-close>✕</button>
    </div>
    <div class="dialog-body">
      <form method="post" action="/api/reposts/quote">
        <input type="hidden" name="post_id" id="quote-post-id" />
        <textarea class="h-20 w-full resize-none rounded border border-border p-2 text-sm" name="quote_text" placeholder="Add a comment (optional)"></textarea>
        <div class="quote-preview">
          <div class="text-xs text-muted" id="quote-meta"></div>
          <div class="mt-1" id="quote-text"></div>
        </div>
        <div class="dialog-actions">
          <button class="btn" type="submit">Quote</button>
        </div>
      </form>
    </div>
  </dialog>

  <script>
    const dialog = document.getElementById("quote-dialog");
    const postIdInput = document.getElementById("quote-post-id");
    const quoteMeta = document.getElementById("quote-meta");
    const quoteText = document.getElementById("quote-text");
    document.querySelectorAll(".js-quote-trigger").forEach((btn) => {
      btn.addEventListener("click", () => {
        postIdInput.value = btn.dataset.postId || "";
        quoteMeta.textContent = `${btn.dataset.postName || ""} @${btn.dataset.postUser || ""} · ${btn.dataset.postTime || ""}`;
        quoteText.textContent = btn.dataset.postText || "";
        dialog.showModal();
      });
    });
    document.querySelector("[data-quote-close]")?.addEventListener("click", () => dialog.close());
  </script>
</Base>
