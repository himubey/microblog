---
import Base from "../../layouts/Base.astro";
import { getSupabaseServerClient } from "../../lib/supabase/server";
import IconReply from "virtual:icons/ic/baseline-chat-bubble-outline";
import IconRepost from "virtual:icons/ic/baseline-repeat";
import IconLike from "virtual:icons/ic/baseline-favorite-border";
import IconLikeFilled from "virtual:icons/ic/baseline-favorite";
import IconQuote from "virtual:icons/ic/baseline-format-quote";

const { username } = Astro.params;
const supabase = getSupabaseServerClient(Astro);
const {
  data: { user },
} = await supabase.auth.getUser();

const formatTime = (ts) => new Date(ts).toLocaleString();

const escapeHtml = (value) =>
  String(value || "")
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;")
    .replace(/"/g, "&quot;")
    .replace(/'/g, "&#39;");

const linkify = (value) => {
  const escaped = escapeHtml(value);
  const withLinks = escaped.replace(/(https?:\/\/[^\s]+)/g, '<a class="text-link" href="$1" target="_blank" rel="noopener noreferrer">$1</a>');
  return withLinks.replace(/(^|\s)#([\w_]+)/g, (_m, lead, tag) => `${lead}<a class="text-link" href="/tag/${tag.toLowerCase()}">#${tag}</a>`);
};

let myProfile = null;
let myProfileError = null;
if (user) {
  const first = await supabase
    .from("profiles")
    .select("id, username, display_name, bio, location, website, avatar_url, pinned_post_id")
    .eq("id", user.id)
    .single();
  if (first.error?.message?.includes("pinned_post_id")) {
    const fallback = await supabase
      .from("profiles")
      .select("id, username, display_name, bio, location, website, avatar_url")
      .eq("id", user.id)
      .single();
    myProfile = fallback.data;
    myProfileError = fallback.error;
  } else {
    myProfile = first.data;
    myProfileError = first.error;
  }
}

const meta = user?.user_metadata || {};

if (user && !myProfile) {
  const fallbackUsername = meta.username || user.email?.split("@")[0] || `user_${user.id.slice(0, 6)}`;
  const fallbackDisplay = meta.display_name || meta.name || "User";
  await supabase.from("profiles").upsert({
    id: user.id,
    username: fallbackUsername,
    display_name: fallbackDisplay,
    bio: meta.bio || null,
    location: meta.location || null,
    website: meta.website || null,
  });
}

let myProfileRefetch = null;
if (user) {
  const refetch = await supabase
    .from("profiles")
    .select("id, username, display_name, bio, location, website, avatar_url, pinned_post_id")
    .eq("id", user.id)
    .single();
  if (refetch.error?.message?.includes("pinned_post_id")) {
    const fallback = await supabase
      .from("profiles")
      .select("id, username, display_name, bio, location, website, avatar_url")
      .eq("id", user.id)
      .single();
    myProfileRefetch = fallback.data;
  } else {
    myProfileRefetch = refetch.data;
  }
}

let profileRow = null;
let profileRowError = null;
const profileFirst = await supabase
  .from("profiles")
  .select("id, username, display_name, bio, location, website, avatar_url, pinned_post_id")
  .eq("username", username)
  .maybeSingle();
if (profileFirst.error?.message?.includes("pinned_post_id")) {
  const profileFallback = await supabase
    .from("profiles")
    .select("id, username, display_name, bio, location, website, avatar_url")
    .eq("username", username)
    .maybeSingle();
  profileRow = profileFallback.data;
  profileRowError = profileFallback.error;
} else {
  profileRow = profileFirst.data;
  profileRowError = profileFirst.error;
}

const effectiveMyProfile = myProfileRefetch || myProfile;

const profile =
  (effectiveMyProfile &&
    (effectiveMyProfile.username === username || user?.email?.split("@")[0] === username)
      ? effectiveMyProfile
      : null) || profileRow;

const profileId =
  profile?.id || effectiveMyProfile?.id || user?.id || "00000000-0000-0000-0000-000000000000";
const displayName =
  profile?.display_name ||
  profile?.username ||
  effectiveMyProfile?.display_name ||
  user?.user_metadata?.name ||
  "User";
const handle =
  profile?.username ||
  effectiveMyProfile?.username ||
  user?.user_metadata?.username ||
  user?.email?.split("@")[0] ||
  username;
const isOwner = Boolean(user?.id && profileId === user.id);

const bio =
  profile?.bio ||
  effectiveMyProfile?.bio ||
  (isOwner ? meta.bio || "" : "");
const location =
  profile?.location ||
  effectiveMyProfile?.location ||
  (isOwner ? meta.location || "" : "");
const website =
  profile?.website ||
  effectiveMyProfile?.website ||
  (isOwner ? meta.website || "" : "");

const { data: postsData } = await supabase
  .from("posts")
  .select("id, author_id, content, created_at, reply_to_id")
  .eq("author_id", profileId)
  .is("reply_to_id", null)
  .order("created_at", { ascending: false });

const { data: quotesData } = await supabase
  .from("reposts")
  .select("id, user_id, post_id, quote_text, created_at, profiles:profiles!reposts_user_id_fkey (id, username, display_name), post:posts!reposts_post_id_fkey (id, content, created_at, author_id, profiles:profiles!posts_author_id_fkey (id, username, display_name))")
  .eq("type", "quote")
  .eq("user_id", profileId)
  .order("created_at", { ascending: false });

const postIds = Array.from(
  new Set([
    ...(postsData || []).map((p) => p.id),
    ...(quotesData || []).map((q) => q.post_id).filter(Boolean),
  ])
);

const { data: repliesData } = await supabase
  .from("posts")
  .select("id, reply_to_id")
  .in("reply_to_id", postIds.length ? postIds : ["00000000-0000-0000-0000-000000000000"]);

const { data: likesData } = await supabase
  .from("likes")
  .select("post_id, user_id")
  .in("post_id", postIds.length ? postIds : ["00000000-0000-0000-0000-000000000000"]);

const { data: repostsData } = await supabase
  .from("reposts")
  .select("post_id, user_id")
  .in("post_id", postIds.length ? postIds : ["00000000-0000-0000-0000-000000000000"]);

const countBy = (rows, key) => {
  const map = new Map();
  (rows || []).forEach((r) => {
    const k = r[key];
    map.set(k, (map.get(k) || 0) + 1);
  });
  return map;
};

const replyCounts = countBy(repliesData, "reply_to_id");
const likeCounts = countBy(likesData, "post_id");
const repostCounts = countBy(repostsData, "post_id");

const likedSet = new Set(
  (likesData || [])
    .filter((r) => r.user_id === user?.id)
    .map((r) => r.post_id)
);
const repostedSet = new Set(
  (repostsData || [])
    .filter((r) => r.user_id === user?.id)
    .map((r) => r.post_id)
);

const posts = (postsData || []).map((p) => ({
  type: "post",
  id: p.id,
  authorId: p.author_id,
  text: p.content,
  time: formatTime(p.created_at),
  createdAt: p.created_at,
  meta: "via web",
  counts: {
    replies: replyCounts.get(p.id) || 0,
    reposts: repostCounts.get(p.id) || 0,
    likes: likeCounts.get(p.id) || 0,
  },
  liked: likedSet.has(p.id),
  reposted: repostedSet.has(p.id),
  isOwner: user?.id === p.author_id,
  isPinned: profile?.pinned_post_id === p.id,
}));

const quotes = (quotesData || [])
  .filter((q) => q.quote_text && q.post)
  .map((q) => ({
    type: "quote",
    id: q.id,
    authorId: q.user_id,
    text: q.quote_text,
    time: formatTime(q.created_at),
    createdAt: q.created_at,
    counts: {
      replies: replyCounts.get(q.post.id) || 0,
      reposts: repostCounts.get(q.post.id) || 0,
      likes: likeCounts.get(q.post.id) || 0,
    },
    liked: likedSet.has(q.post.id),
    reposted: repostedSet.has(q.post.id),
    quoted: {
      id: q.post.id,
      user: q.post.profiles?.username || "user",
      name: q.post.profiles?.display_name || q.post.profiles?.username || "User",
      text: q.post.content,
      time: formatTime(q.post.created_at),
    },
  }));

const combined = [...posts, ...quotes].sort(
  (a, b) => new Date(b.createdAt).getTime() - new Date(a.createdAt).getTime()
);
const pinnedPosts = combined.filter((p) => p.type === "post" && p.isPinned);
const regularPosts = combined.filter((p) => !(p.type === "post" && p.isPinned));
const orderedPosts = [...pinnedPosts, ...regularPosts];

const { count: followersCount } = await supabase
  .from("follows")
  .select("*", { count: "exact", head: true })
  .eq("followee_id", profileId);

const { count: followingCount } = await supabase
  .from("follows")
  .select("*", { count: "exact", head: true })
  .eq("follower_id", profileId);

const { count: postsCount } = await supabase
  .from("posts")
  .select("*", { count: "exact", head: true })
  .eq("author_id", profileId)
  .is("reply_to_id", null);

const { data: followersPreview } = await supabase
  .from("follows")
  .select("follower_id, profiles:profiles!follows_follower_id_fkey (id, username, display_name, avatar_url)")
  .eq("followee_id", profileId)
  .limit(10);

const followerList = (followersPreview || []).map((row) => row.profiles).filter(Boolean);
---
<Base title={`Microblog - @${username}`}>
  <div class="grid gap-4 md:grid-cols-[2fr_1fr]">
    <div>
      <section class="card p-4">
        <div class="grid grid-cols-[72px_1fr] gap-4">
          <img src="/assets/default-avatar.webp" alt="" class="h-18 w-18 rounded border border-border object-cover" />
          <div>
            <h1 class="text-lg font-bold">{displayName}</h1>
            <div class="text-sm text-muted">@{handle}</div>
            <div class="mt-2 text-sm" set:html={bio ? linkify(bio) : "No bio yet."}></div>
            <div class="mt-2 text-xs text-muted">
              {location ? `Location: ${location}` : ""}
              {location && website ? " · " : ""}
              {website ? `Website: ${website}` : ""}
            </div>
          </div>
        </div>
        <div class="mt-3 grid grid-cols-3 gap-2 text-center text-xs">
          <div>
            <div class="font-bold">{postsCount || 0}</div>
            <div class="text-muted">Posts</div>
          </div>
          <div>
            <a class="font-bold text-link" href={`/profile/${handle}/following`}>{followingCount || 0}</a>
            <div class="text-muted">Following</div>
          </div>
          <div>
            <a class="font-bold text-link" href={`/profile/${handle}/followers`}>{followersCount || 0}</a>
            <div class="text-muted">Followers</div>
          </div>
        </div>
      </section>

      <section class="card mt-3">
        <div class="border-b border-[#edf3f7] px-3 py-2 text-xs text-muted">All posts</div>
        {orderedPosts.length === 0 && (
          <div class="p-4 text-sm text-muted">No posts yet.</div>
        )}
        {orderedPosts.map((post) => (
          <div class="post-card">
            <img src="/assets/default-avatar.webp" alt="" class="post-avatar" />
            <div class="post-body">
              <div class="post-header">
                <div class="post-meta">
                  <a href={`/profile/${handle}`} class="font-bold text-link">{displayName}</a>
                  <span class="post-handle"> @{handle}</span>
                  <span class="post-time">· <a class="text-link" href={`/post/${post.type === "post" ? post.id : post.quoted.id}`}>{post.time}</a></span>
                </div>
                {post.type === "post" && (
                  <span class="post-menu-wrap">
                    {post.reposted && (
                      <span class="post-reposted" title="Reposted" aria-label="Reposted">
                        <IconRepost class="action-icon-svg" />
                      </span>
                    )}
                    {post.isPinned && (
                      <span class="post-pin-inline" title="Pinned post" aria-label="Pinned post">
                        <svg viewBox="0 0 20 20" aria-hidden="true">
                          <path d="M6 2h8l-1 5 3 3v2H4v-2l3-3-1-5zm3 11v5h2v-5H9z"></path>
                        </svg>
                      </span>
                    )}
                    <button class="post-menu-button" type="button">...</button>
                    <span class="post-menu">
                      {post.isOwner ? (
                        <>
                          <form method="post" action="/api/posts/delete">
                            <input type="hidden" name="post_id" value={post.id} />
                            <button class="post-menu-item danger" type="submit">Delete post</button>
                          </form>
                          <form method="post" action="/api/posts/pin">
                            <input type="hidden" name="post_id" value={post.id} />
                            <button class="post-menu-item" type="submit">{post.isPinned ? "Unpin from profile" : "Pin to your profile"}</button>
                          </form>
                        </>
                      ) : (
                        <>
                          <form method="post" action="/api/follows/unfollow">
                            <input type="hidden" name="followee_id" value={post.authorId} />
                            <button class="post-menu-item" type="submit">Unfollow @{handle}</button>
                          </form>
                          <form method="post" action="/api/mutes/toggle">
                            <input type="hidden" name="muted_id" value={post.authorId} />
                            <button class="post-menu-item" type="submit">Mute @{handle}</button>
                          </form>
                          <form method="post" action="/api/blocks/toggle">
                            <input type="hidden" name="blocked_id" value={post.authorId} />
                            <button class="post-menu-item" type="submit">Block @{handle}</button>
                          </form>
                        </>
                      )}
                      <a class="post-menu-item" href={`/post/${post.id}/activity`}>View post activity</a>
                    </span>
                  </span>
                )}
              </div>
              <div class="post-link" data-href={`/post/${post.type === "post" ? post.id : post.quoted.id}`}>
                <div class="post-content" set:html={linkify(post.text)}></div>
              </div>
              {post.type === "quote" && (
                <div class="post-link" data-href={`/post/${post.quoted.id}`}>
                  <div class="quote-card">
                    <div class="quote-meta">{post.quoted.name} @{post.quoted.user} · {post.quoted.time}</div>
                    <div class="quote-text" set:html={linkify(post.quoted.text)}></div>
                  </div>
                </div>
              )}
              <div class="post-actions">
                <a class="action-link action-icon" href={`/post/${post.type === "post" ? post.id : post.quoted.id}`}>
                  <IconReply class="action-icon-svg" />
                  {post.counts.replies}
                </a>
                <span class="repost-wrap">
                  <form method="post" action="/api/reposts/repost" class="inline">
                    <input type="hidden" name="post_id" value={post.type === "post" ? post.id : post.quoted.id} />
                    <button class="action-link action-icon" type="submit">
                      <IconRepost class="action-icon-svg" />
                      {post.counts.reposts}
                    </button>
                  </form>
                  <span class="repost-menu">
                    <form method="post" action="/api/reposts/repost">
                      <input type="hidden" name="post_id" value={post.id} />
                      <button class="post-menu-item" type="submit">Repost</button>
                    </form>
                    <button
                      class="post-menu-item js-quote-trigger"
                      type="button"
                      data-post-id={post.id}
                      data-post-text={post.text}
                      data-post-name={displayName}
                      data-post-user={handle}
                      data-post-time={post.time}
                    >
                      <IconQuote class="action-icon-svg" /> Quote
                    </button>
                  </span>
                </span>
                <span>·</span>
                <form method="post" action="/api/likes/toggle" class="inline">
                  <input type="hidden" name="post_id" value={post.type === "post" ? post.id : post.quoted.id} />
                  <button class={`action-link action-icon ${post.liked ? "is-liked" : ""}`} type="submit">
                    {post.liked ? <IconLikeFilled class="action-icon-svg" /> : <IconLike class="action-icon-svg" />}
                    {post.counts.likes}
                  </button>
                </form>
              </div>
            </div>
          </div>
        ))}
      </section>
    </div>

    <aside class="card p-4">
      <h3 class="text-sm font-bold">Profile</h3>
      <div class="mt-2 text-xs text-muted">Name: {displayName}</div>
      <div class="text-xs text-muted">Username: @{handle}</div>
      <div class="text-xs text-muted">Location: {location || "—"}</div>
      <div class="text-xs text-muted">Website: {website || "—"}</div>
      <div class="mt-3 text-xs text-muted">Bio: <span set:html={bio ? linkify(bio) : "—"}></span></div>
      {!isOwner && <button class="btn mt-4" type="button">Follow</button>}

      <h3 class="mt-4 text-sm font-bold">Followers</h3>
      <p class="mt-1 text-xs text-muted">
        View the full list on the{" "}
        <a class="text-link" href={`/profile/${handle}/followers`}>followers</a> page.
      </p>
      {followerList.length === 0 ? (
        <p class="mt-2 text-xs text-muted">No followers yet.</p>
      ) : (
        <div class="mt-2 grid grid-cols-5 gap-1">
          {followerList.map((person) => (
            <a href={`/profile/${person.username}`} title={person.display_name || person.username}>
              <img
                src={person.avatar_url || "/assets/default-avatar.webp"}
                alt=""
                class="h-8 w-8 rounded border border-border object-cover"
              />
            </a>
          ))}
        </div>
      )}
    </aside>
  </div>

  <dialog class="quote-dialog" id="quote-dialog">
    <div class="dialog-header">
      <div class="dialog-title">Quote post</div>
      <button class="post-menu-button" type="button" data-quote-close>✕</button>
    </div>
    <div class="dialog-body">
      <form method="post" action="/api/reposts/quote">
        <input type="hidden" name="post_id" id="quote-post-id" />
        <textarea class="h-20 w-full resize-none rounded border border-border p-2 text-sm" name="quote_text" placeholder="Add a comment (optional)"></textarea>
        <div class="quote-preview">
          <div class="text-xs text-muted" id="quote-meta"></div>
          <div class="mt-1" id="quote-text"></div>
        </div>
        <div class="dialog-actions">
          <button class="btn" type="submit">Quote</button>
        </div>
      </form>
    </div>
  </dialog>

  <script>
    const dialog = document.getElementById("quote-dialog");
    const postIdInput = document.getElementById("quote-post-id");
    const quoteMeta = document.getElementById("quote-meta");
    const quoteText = document.getElementById("quote-text");
    document.querySelectorAll(".js-quote-trigger").forEach((btn) => {
      btn.addEventListener("click", () => {
        postIdInput.value = btn.dataset.postId || "";
        quoteMeta.textContent = `${btn.dataset.postName || ""} @${btn.dataset.postUser || ""} · ${btn.dataset.postTime || ""}`;
        quoteText.textContent = btn.dataset.postText || "";
        dialog.showModal();
      });
    });
    document.querySelector("[data-quote-close]")?.addEventListener("click", () => dialog.close());

    document.querySelectorAll(".post-link[data-href]").forEach((el) => {
      el.addEventListener("click", (event) => {
        if (event.target.closest("a")) return;
        const href = el.getAttribute("data-href");
        if (href) window.location.href = href;
      });
    });
  </script>
</Base>
