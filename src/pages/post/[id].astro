---
import Base from "../../layouts/Base.astro";
import { getSupabaseServerClient } from "../../lib/supabase/server";

const { id } = Astro.params;
const supabase = getSupabaseServerClient(Astro);

const { data: postRow } = await supabase
  .from("posts")
  .select("id, author_id")
  .eq("id", id)
  .maybeSingle();

let username = null;
if (postRow?.author_id) {
  const { data: author } = await supabase
    .from("profiles")
    .select("username")
    .eq("id", postRow.author_id)
    .maybeSingle();
  username = author?.username || null;
}

if (!postRow) {
  const { data: quoteRow } = await supabase
    .from("reposts")
    .select("id, user_id")
    .eq("id", id)
    .eq("type", "quote")
    .maybeSingle();

  if (quoteRow?.user_id) {
    const { data: quoteAuthor } = await supabase
      .from("profiles")
      .select("username")
      .eq("id", quoteRow.user_id)
      .maybeSingle();
    username = quoteAuthor?.username || null;
  }
}

if (username) {
  return Astro.redirect(`/${username}/post/${id}`, 301);
}
---
<Base title="Microblog - Post">
  <section class="card p-4 text-sm text-muted">Post not found.</section>
</Base>
