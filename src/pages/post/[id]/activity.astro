---
import Base from "../../../layouts/Base.astro";
import { getSupabaseServerClient } from "../../../lib/supabase/server";

const { id } = Astro.params;
const supabase = getSupabaseServerClient(Astro);

const { data: postRow } = await supabase
  .from("posts")
  .select("id, author_id")
  .eq("id", id)
  .maybeSingle();

let username = null;
if (postRow?.author_id) {
  const { data: author } = await supabase
    .from("profiles")
    .select("username")
    .eq("id", postRow.author_id)
    .maybeSingle();
  username = author?.username || null;
}

if (username) {
  return Astro.redirect(`/${username}/post/${id}/activity`, 301);
}
---
<Base title="Microblog - Activity">
  <section class="card p-4 text-sm text-muted">Post not found.</section>
</Base>
